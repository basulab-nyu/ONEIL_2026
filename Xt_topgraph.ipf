#pragma rtglobals=1macro Xt_topgraph()pXt_topgraph()proc pXt_topgraph(str_base_moving,str_base_fixed,str_search,str_window,str_delta,str_spike,str_output)string str_base_movingprompt str_base_moving "moving stim onset (ms) ?" //defaults to 1128.65 or cursorstring str_base_fixedprompt str_base_fixed "fixed stim onset (ms) ?" //defaults to 1178.65 or cursorstring str_searchprompt str_search "peak detection latency (ms) ?" //defaults to stim+15 or cursorstring str_windowprompt str_window "peak averaging window (ms) ?" //defaults to 5string str_deltaprompt str_delta "moving stim delta (ms) ?" //defaults to 10string str_spikeprompt str_spike "spike threshold (mV) ?" //defaults to -40string str_outputprompt str_output "output wave ?" //defaults to PSP_filenameif(strlen(str_base_moving) == 0)	str_base_moving = "1128.65"endifif(strlen(str_base_fixed) == 0)	str_base_fixed = "1178.65"endifif(strlen(str_search) == 0)	str_search = "15"endifif(strlen(str_window) == 0)	str_window = "5"endifif(strlen(str_delta) == 0)	str_delta = "10"endifif(strlen(str_spike) == 0)	str_spike = "-40"endifif(strlen(str_output) == 0)	str_output = "PSP_"+igorinfo(1)else	str_output = "PSP_"+str_outputendifvariable var_base_moving = str2num(str_base_moving)variable var_base_fixed = str2num(str_base_fixed)variable var_search = str2num(str_search)variable var_window = str2num(str_window)variable var_delta = str2num(str_delta)variable var_spike = str2num(str_spike)string str_listvariable var_indexvariable var_b1variable var_p1variable var_b2variable var_p2pauseupdatestr_list = listmatch(sortlist(tracenamelist("",";",1),";",16),"*PSP*")str_list = removefromlist(greplist(str_list,"(#)"),str_list)if(itemsinlist(str_list)>0)	var_index = 0	do		do			checkdisplayed $stringfromlist(var_index,str_list)			removefromgraph/z $stringfromlist(var_index,str_list)		while(v_flag == 1)		var_index+=1	while(var_index<itemsinlist(str_list))endifresumeupdatestr_list = sortlist(tracenamelist("",";",1),";",16)print replacestring(";",str_list,"\r")if(strlen(csrinfo(A)) == 0 || strlen(csrinfo(B)) == 0 || strlen(csrinfo(C)) == 0 || strlen(csrinfo(D)) == 0)	cursor A $stringfromlist(0,str_list) var_base_moving	cursor B $stringfromlist(0,str_list) var_base_moving+var_search	cursor C $stringfromlist(0,str_list) var_base_fixed	cursor D $stringfromlist(0,str_list) var_base_fixed+var_searchendifmake/o/n=4 w_sort = NaNw_sort[0] = xcsr(A)w_sort[1] = xcsr(B)w_sort[2] = xcsr(C)w_sort[3] = xcsr(D)sort w_sort, w_sortvar_b1 = w_sort[0]var_p1 = w_sort[1]var_b2 = w_sort[2]var_p2 = w_sort[3]make/o/n=(itemsinlist(str_list),24) $str_output = nansetdimlabel 1,0,base_t_0,$str_outputsetdimlabel 1,1,base_v_0,$str_outputsetdimlabel 1,2,base_t_1,$str_outputsetdimlabel 1,3,base_v_1,$str_outputsetdimlabel 1,4,peak_avg_t_1,$str_outputsetdimlabel 1,5,peak_avg_v_1,$str_outputsetdimlabel 1,6,peak_max_t_1,$str_outputsetdimlabel 1,7,peak_max_v_1,$str_outputsetdimlabel 1,8,amp_avg_1,$str_outputsetdimlabel 1,9,amp_max_1,$str_outputsetdimlabel 1,10,sum_avg_1,$str_outputsetdimlabel 1,11,sum_max_1,$str_outputsetdimlabel 1,12,spike_1,$str_outputsetdimlabel 1,13,base_t_2,$str_outputsetdimlabel 1,14,base_v_2,$str_outputsetdimlabel 1,15,peak_avg_t_2,$str_outputsetdimlabel 1,16,peak_avg_v_2,$str_outputsetdimlabel 1,17,peak_max_t_2,$str_outputsetdimlabel 1,18,peak_max_v_2,$str_outputsetdimlabel 1,19,amp_avg_2,$str_outputsetdimlabel 1,20,amp_max_2,$str_outputsetdimlabel 1,21,sum_avg_2,$str_outputsetdimlabel 1,22,sum_max_2,$str_outputsetdimlabel 1,23,spike_2,$str_outputvar_index = 0pauseupdatedo	setdimlabel 0,var_index,$stringfromlist(var_index,str_list),$str_output	wavestats/q/r=((itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_b1-0.5*var_window,(itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_b1+0.5*var_window) $stringfromlist(var_index,str_list)	if(v_max<var_spike)		$str_output[var_index][%base_t_1] = (itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_b1		$str_output[var_index][%base_v_1] = v_avg		wavestats/q/r=((itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_p1-0.5*var_window,(itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_p1+0.5*var_window) $stringfromlist(var_index,str_list)		if(v_max>var_spike)			$str_output[var_index][%peak_max_t_1] = v_maxloc			$str_output[var_index][%peak_max_v_1] = v_max			$str_output[var_index][%spike_1] = 1		else			$str_output[var_index][%peak_avg_t_1] = (itemsinlist(str_list)-1)*var_delta-var_index*var_delta+var_p1			$str_output[var_index][%peak_avg_v_1] = v_avg			$str_output[var_index][%amp_avg_1] = $str_output[var_index][%peak_avg_v_1]-$str_output[var_index][%base_v_1]			$str_output[var_index][%peak_max_t_1] = v_maxloc			wavestats/q/r=($str_output[var_index][%peak_max_t_1]-0.5*var_window,$str_output[var_index][%peak_max_t_1]+0.5*var_window) $stringfromlist(var_index,str_list)			$str_output[var_index][%peak_max_v_1] = v_avg			$str_output[var_index][%amp_max_1] = $str_output[var_index][%peak_max_v_1]-$str_output[var_index][%base_v_1]		endif	endif	wavestats/q/r=(var_b2-0.5*var_window,var_b2+0.5*var_window) $stringfromlist(var_index,str_list)	if(v_max<var_spike)		$str_output[var_index][%base_t_2] = var_b2		$str_output[var_index][%base_v_2] = v_avg		wavestats/q/r=(var_p2-0.5*var_window,var_p2+0.5*var_window) $stringfromlist(var_index,str_list)		if(v_max>var_spike)			$str_output[var_index][%peak_max_t_2] = v_maxloc			$str_output[var_index][%peak_max_v_2] = v_max			$str_output[var_index][%spike_2] = 1		else			$str_output[var_index][%peak_avg_t_2] = var_p2			$str_output[var_index][%peak_avg_v_2] = v_avg			$str_output[var_index][%amp_avg_2] = $str_output[var_index][%peak_avg_v_2]-$str_output[var_index][%base_v_2]			$str_output[var_index][%peak_max_t_2] = v_maxloc			wavestats/q/r=($str_output[var_index][%peak_max_t_2]-0.5*var_window,$str_output[var_index][%peak_max_t_2]+0.5*var_window) $stringfromlist(var_index,str_list)			$str_output[var_index][%peak_max_v_2] = v_avg			$str_output[var_index][%amp_max_2] = $str_output[var_index][%peak_max_v_2]-$str_output[var_index][%base_v_2]		endif	endif	wavestats/q/r=(var_b1-0.5*var_window,var_b1+0.5*var_window) $stringfromlist(var_index,str_list)	if(v_max<var_spike)		$str_output[var_index][%base_t_0] = var_b1		$str_output[var_index][%base_v_0] = v_avg		if(numtype($str_output[var_index][%spike_1]) == 2)			$str_output[var_index][%sum_avg_1] = $str_output[var_index][%peak_avg_v_1]-$str_output[var_index][%base_v_0]			$str_output[var_index][%sum_max_1] = $str_output[var_index][%peak_max_v_1]-$str_output[var_index][%base_v_0]		endif		if(numtype($str_output[var_index][%spike_2]) == 2)			$str_output[var_index][%sum_avg_2] = $str_output[var_index][%peak_avg_v_2]-$str_output[var_index][%base_v_0]			$str_output[var_index][%sum_max_2] = $str_output[var_index][%peak_max_v_2]-$str_output[var_index][%base_v_0]		endif	endif	var_index+=1while(var_index<itemsinlist(str_list))appendtograph $str_output[][%base_v_1] vs $str_output[][%base_t_1]appendtograph $str_output[][%peak_avg_v_1] vs $str_output[][%peak_avg_t_1]appendtograph $str_output[][%peak_max_v_1] vs $str_output[][%peak_max_t_1]appendtograph $str_output[][%base_v_2] vs $str_output[][%base_t_2]appendtograph $str_output[][%peak_avg_v_2] vs $str_output[][%peak_avg_t_2]appendtograph $str_output[][%peak_max_v_2] vs $str_output[][%peak_max_t_2]modifygraph mode($str_output)=3,rgb($str_output)=(65535,16385,36045),mrkthick($str_output)=2modifygraph mode($(str_output+"#1"))=3,rgb($(str_output+"#1"))=(65535,0,0),mrkthick($(str_output+"#1"))=2modifygraph mode($(str_output+"#2"))=3,rgb($(str_output+"#2"))=(65535,43690,0),mrkthick($(str_output+"#2"))=2 modifygraph mode($(str_output+"#3"))=3,rgb($(str_output+"#3"))=(36873,14755,58982),mrkthick($(str_output+"#3"))=2 modifygraph mode($(str_output+"#4"))=3,rgb($(str_output+"#4"))=(16385,28398,65535),mrkthick($(str_output+"#4"))=2 modifygraph mode($(str_output+"#5"))=3,rgb($(str_output+"#5"))=(2,39321,1),mrkthick($(str_output+"#5"))=2 resumeupdatekillwaves/z w_sortcursor/k Acursor/k Bcursor/k Ccursor/k Dend